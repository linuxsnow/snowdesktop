#!/bin/sh
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2016 Jonathan Riddell <jr@jriddell.org>
# SPDX-FileCopyrightText: 2017-2021 Harald Sitter <sitter@kde.org>
# Derived from KDE Linux Live Setup Script

set -eux

if ! grep "snow-linux.live=1" /proc/cmdline; then
    echo "snow-linux.live=1 not in cmdline"
    exit 1
fi


groupadd -g 1000 live
useradd --create-home --comment "Snow User" live
usermod --append --groups sudo live
passwd --delete live

# systemd is a bit unreliable with creating the file if the timezone is UTC, so make sure it's in place
ln -s ../usr/share/zoneinfo/UTC /etc/localtime

timedatectl set-timezone UTC

mkdir --parents /etc/gdm/
cat << EOF > /etc/gdm/custom.conf
[daemon]
AutomaticLoginEnable=True
AutomaticLogin=live
EOF

mkdir /home/live/.config/
mkdir /home/live/Desktop/


# cp /usr/share/applications/calamares.desktop /home/live/Desktop/
# chmod +x /home/live/Desktop/calamares.desktop # without this there'd be a dialog asking if it really should execute

chown -R live:live /home/live/

# Start the basic-test (if it wants to be started)
systemctl daemon-reload
#systemctl start --no-block kde-linux-basic-test.service
